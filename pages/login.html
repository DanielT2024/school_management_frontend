{% extends 'base.html' %}

{% block title %}Login - School Management System{% endblock %}

{% block content %}
<div class="auth-container d-flex align-items-center justify-content-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="auth-card p-4">
                    <div class="text-center mb-4">
                        <h2 class="fw-bold text-primary">
                            <i class="fas fa-graduation-cap me-2"></i>
                            School System
                        </h2>
                        <p class="text-muted">Sign in to your account</p>
                    </div>

                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-envelope"></i>
                                </span>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2 mb-3">
                            <i class="fas fa-sign-in-alt me-2"></i>
                            Sign In
                        </button>

                        <div class="text-center">
                            <p class="mb-0">
                                Don't have an account? 
                                <a href="register.html" class="text-decoration-none">Register your school</a>
                            </p>
                            <p class="mt-2">
                                <a href="index.html" class="text-decoration-none">‚Üê Back to Home</a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="../static/js/utils.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîê Login page loaded');

    if (!window.schoolUtils) {
        console.error('‚ùå schoolUtils not found. Make sure utils.js is loaded first.');
        document.body.innerHTML = '<div class="alert alert-danger">Critical error: Utility script not loaded. Please contact support.</div>';
        return;
    }

    // Redirect if already logged in
    if (schoolUtils.isAuthenticated()) {
        console.log('‚úÖ User is authenticated, redirecting to dashboard...');
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const redirectUrl = userData.user_type === 'super_admin' ? '/super-admin-dashboard.html' : '/dashboard.html';
        window.location.href = redirectUrl;
        return;
    } else {
        console.log('üîê User not authenticated, staying on login page');
    }

    // Handle login submission
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        // Basic input validation
        if (!email || !password) {
            schoolUtils.showAlert('Please enter both email and password.', 'warning');
            return;
        }
        if (!schoolUtils.validateEmail(email)) {
            schoolUtils.showAlert('Please enter a valid email address.', 'warning');
            return;
        }
        if (password.length < 6) {
            schoolUtils.showAlert('Password must be at least 6 characters long.', 'warning');
            return;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing In...';

        try {
            console.log('üîê Attempting login for:', email);

            // Use schoolUtils.apiPost for consistency
            const response = await schoolUtils.apiPost('/api/auth/login/', {
                email: email,
                password: password
            });

            console.log('‚úÖ Login successful:', response.data);

            const { token, user, tenant } = response.data;
            localStorage.setItem('authToken', token);
            localStorage.setItem('userData', JSON.stringify(user));
            if (tenant) {
                localStorage.setItem('tenantData', JSON.stringify(tenant));
            } else {
                localStorage.removeItem('tenantData'); // Clear tenantData if not provided
            }

            schoolUtils.showAlert('Login successful! Redirecting...', 'success');

            // Redirect based on user type
            const redirectUrl = user.user_type === 'super_admin' ? '/super-admin-dashboard.html' : '/dashboard.html';
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 1000);

        } catch (error) {
            console.error('‚ùå Login error:', error);
            // Error is already handled by schoolUtils.handleApiError
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Sign In';
        }
    });
});
</script>

{% endblock %}