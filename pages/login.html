{% extends 'base.html' %}

{% block title %}Login - School Management System{% endblock %}

{% block content %}
<div class="auth-container d-flex align-items-center justify-content-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="auth-card p-4">
                    <div class="text-center mb-4">
                        <h2 class="fw-bold text-primary">
                            <i class="fas fa-graduation-cap me-2"></i>
                            School System
                        </h2>
                        <p class="text-muted">Sign in to your account</p>
                    </div>

                    <form id="loginForm">
                        <!-- üè´ School selector -->
                        <div class="mb-3">
                            <label for="schoolSelect" class="form-label">Select Your School</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-school"></i>
                                </span>
                                <select id="schoolSelect" class="form-select" required>
                                    <option value="">Loading schools...</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-envelope"></i>
                                </span>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2 mb-3">
                            <i class="fas fa-sign-in-alt me-2"></i>
                            Sign In
                        </button>

                        <div class="text-center">
                            <p class="mb-0">
                                Don't have an account? 
                                <a href="register.html" class="text-decoration-none">Register your school</a>
                            </p>
                            <p class="mt-2">
                                <a href="index.html" class="text-decoration-none">‚Üê Back to Home</a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="../static/js/utils.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîê Login page loaded');

    if (!window.schoolUtils) {
        console.error('‚ùå schoolUtils not found. Make sure utils.js is loaded first.');
        document.body.innerHTML = '<div class="alert alert-danger">Critical error: Utility script not loaded. Please contact support.</div>';
        return;
    }

    // Debug environment info
    console.log('üåê Environment:', schoolUtils.getEnvironment());
    console.log('üöÄ API Base:', schoolUtils.getAPI_BASE());

    // Redirect if already logged in
    if (schoolUtils.isAuthenticated()) {
        console.log('‚úÖ User is authenticated, redirecting to dashboard...');
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const redirectUrl = userData.user_type === 'super_admin' ? '/super-admin-dashboard.html' : '/dashboard.html';
        window.location.href = redirectUrl;
        return;
    }

    // üè´ Load schools (tenants)
    const schoolSelect = document.getElementById('schoolSelect');
    try {
        console.log('üì° Fetching schools from backend...');
        
        // ‚úÖ FIXED: Use the method to get API base
        const apiBase = schoolUtils.getAPI_BASE();
        console.log('üåê Using API Base:', apiBase);
        
        const res = await axios.get(`${apiBase}/api/auth/tenants/`);
        console.log('üè´ Schools API response:', res.data);
        
        if (res.data && res.data.length > 0) {
            schoolSelect.innerHTML = '<option value="">Select your school</option>';
            res.data.forEach(school => {
                const option = document.createElement('option');
                option.value = school.schema_name;
                option.textContent = school.school_name || school.name || school.schema_name;
                schoolSelect.appendChild(option);
            });
            console.log(`‚úÖ Loaded ${res.data.length} schools`);
        } else {
            schoolSelect.innerHTML = '<option value="">No schools available</option>';
            console.warn('‚ö†Ô∏è No schools found in API response');
        }
    } catch (err) {
        console.error('‚ùå Failed to load schools:', err);
        schoolSelect.innerHTML = '<option value="">Failed to load schools</option>';
        
        // Show environment-specific error message
        const env = schoolUtils.getEnvironment();
        const errorMsg = env === 'development' 
            ? 'Could not load schools. Make sure your Django backend is running on localhost:8000'
            : 'Could not load schools. Please try again later.';
        schoolUtils.showAlert(errorMsg, 'error');
    }

    // üß† Handle login submission
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const schoolSchema = schoolSelect.value.trim();

        console.log('üîê Login attempt:', { email, schoolSchema });

        if (!schoolSchema) {
            schoolUtils.showAlert('Please select your school.', 'warning');
            return;
        }
        if (!email || !password) {
            schoolUtils.showAlert('Please enter both email and password.', 'warning');
            return;
        }
        if (!schoolUtils.validateEmail(email)) {
            schoolUtils.showAlert('Please enter a valid email address.', 'warning');
            return;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing In...';

        try {
            console.log('üîê Attempting login...');
            
            const response = await schoolUtils.apiPost('/api/auth/login/', {
                school: schoolSchema,
                username: email,
                password: password
            });

            console.log('‚úÖ Login successful:', response.data);
            
            const { token, user, tenant } = response.data;
            localStorage.setItem('authToken', token);
            localStorage.setItem('userData', JSON.stringify(user));
            if (tenant) {
                localStorage.setItem('tenantData', JSON.stringify(tenant));
            }

            console.log('üè´ Multi-tenant login successful - Schema:', tenant.schema_name);
            schoolUtils.showAlert(`Welcome to ${tenant.school_name}!`, 'success');
            
            // üö® SIMPLE REDIRECT - Stay on frontend domain
            setTimeout(() => {
                const redirectUrl = user.user_type === 'super_admin' 
                    ? '/super-admin-dashboard.html' 
                    : '/dashboard.html';
                console.log(`üîÑ Redirecting to: ${redirectUrl}`);
                window.location.href = redirectUrl;
            }, 1000);

        } catch (error) {
            console.error('‚ùå Login error:', error);
            
            // Show specific error messages
            if (error.response?.data?.error) {
                schoolUtils.showAlert(error.response.data.error, 'error');
            } else if (error.response?.data?.details) {
                schoolUtils.showAlert(error.response.data.details, 'error');
            } else {
                const env = schoolUtils.getEnvironment();
                const errorMsg = env === 'development'
                    ? 'Login failed. Make sure backend is running on localhost:8000'
                    : 'Login failed. Please check your credentials.';
                schoolUtils.showAlert(errorMsg, 'error');
            }
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Sign In';
        }
    });

    // Test backend connection on load
    async function testBackendConnection() {
        try {
            const apiBase = schoolUtils.getAPI_BASE();
            console.log('üîç Testing backend connection to:', apiBase);
            const testResponse = await fetch(`${apiBase}/health/`);
            const data = await testResponse.json();
            console.log('‚úÖ Backend connection test:', data);
        } catch (err) {
            console.error('üîç Backend connection test failed:', err);
        }
    }
    
    // Uncomment to test backend connection on page load
    // testBackendConnection();
});
</script>
{% endblock %}
